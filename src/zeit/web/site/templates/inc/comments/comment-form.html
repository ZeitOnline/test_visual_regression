{% set pid = view.request.GET['pid'] | d(None) %}

{%- if pid and view.comments -%}
	{% set comment = view.comments.index[pid | int] | d(None) %}
{%- endif %}

{% if comment %}
	{% set submit_value = 'Antworten' %}
	{% set placeholder = 'Ihre Antwort auf Kommentar #' + comment.shown_num + ' von ' + comment.name %}
	{% set class = '' %}
{% else %}
	{% set submit_value = 'Kommentar senden' %}

	{% if not request.authenticated_userid %}
		{% set submit_value = 'Absenden' %}
	{% endif %}

	{% set placeholder = 'Ihr Kommentar' %}
	{% set class = 'comment-form__cancel--hidden' %}
{% endif %}

<div class="comment-section__form comment-section__item">
{%- if request.authenticated_userid %}
	{%- block comment_form %}
	<form class="comment-form  js-submit-comment" method="POST" id="comment-form" data-uid="{{ request.session.user.uid }}">
		{% if view.comments_allowed -%}
		<div class="comment-form__text">
			{% if request.session.user.picture %}
			<img class="comment-form__avatar" alt="Avatarbild von {{ request.session.user.name }}" src="{{ request.session.user.picture }}">
			{% endif %}
                        {% if not request.session.user.name %}
				Angemeldet, noch kein Benutzername
				<a class="comment-form__username" href="{{ request.registry.settings.community_host }}/user">
				(Profil bearbeiten)
				 </a>

			{% else %}
			    Angemeldet als
			    <a class="comment-form__username" href="{{ request.registry.settings.community_host }}/user">
			    	{{ request.session.user.name }}
			    </a>
			{% endif %}
			{% if request.registry.settings.sso_activate %}
				<a class="comment-form__cancel" href="{{ request.registry.settings.sso_url}}/abmelden?url={{ view.content_url | e }}">
				Abmelden
				</a>
                        {% else %}
				<a class="comment-form__cancel" href="{{ request.registry.settings.community_host }}/logout?destination={{ view.content_url | e }}">
				Abmelden
				</a>
                        {% endif %}
		</div>
		{% if request.registry.settings.sso_activate %}
			{% if not request.session.user.name %}
				{% if view.error and not view.error.error == 'username_exists_or_invalid' %}
				    <p class='comment-form__hint comment-form__hint--error'>
				{% else %}
				    <p class='comment-form__hint'>
				{% endif %}
				<strong>Achtung: </strong>Die Registrierung
			bei ZEIT ONLINE erfolgt nur mit Ihrer E-Mail-Adresse.
			Um kommentieren zu können, benötigen Sie allerdings
			noch einen zusätzlichen Benutzernamen. Diesen können
			Sie hier anlegen.</p> 
				<input class="comment-form__input" placeholder="Ihr neuer Benutzername" type="text" name="username" {% if view.error.user_name %}value="{{ view.error.user_name }}"{% endif %}>
				{% if view.error.error == 'username_exists_or_invalid' %}
					<div class='comment-form__error'>Benutzername ist bereits vergeben oder enthält ungültige Zeichen.</div>
				{% endif %}
			{% endif %}
                {% endif %}
		<textarea class="comment-form__textarea js-required" name="comment" placeholder="{{ placeholder }}" maxlength="1500">
{% if view.error and view.error.comment %}{{ view.error.comment }}{% endif %}</textarea>
		<p class="comment-form__actions">
			<input type="hidden" name="action" value="comment">
			<input type="hidden" name="pid" value="{{ pid }}">
			<a href="{{ view.content_url }}" class="comment-form__cancel {{ class }} js-cancel-reply">Abbrechen</a>
			<input class="button" type="submit" value="{{ submit_value }}" />
		</p>
		{%- endif %}
	</form>
	{%- endblock %}
{%- else %}
	<form class="comment-login" id="comment-form">
		<p>
			Bitte melden Sie sich an, um zu kommentieren.
		</p>
                {% if request.registry.settings.sso_activate %}
		    <a class="button" href="{{
                        request.registry.settings.sso_url }}/anmelden?url={{ view.content_url | e }}">
		    	Anmelden
		    </a>
		    <a class="button" href="{{
                        request.registry.settings.sso_url }}/registrieren?url={{ view.content_url | e }}">
			Registrieren
		    </a>
                {% else %}
		    <a class="button" href="{{ request.registry.settings.community_host }}/user/login?destination={{ view.content_url | e }}">
		    	Anmelden
		    </a>
		    <a class="button" href="{{ request.registry.settings.community_host }}/user/register?destination={{ view.content_url | e }}">
			Registrieren
		    </a>
                {% endif %}
	</form>
{%- endif %}
</div>

<script type="text/template" id="js-report-comment-template">
{%- if request.authenticated_userid %}
	{% include "zeit.web.site:templates/inc/comments/report-comment-form.html" %}
{%- else %}
	<form class="comment-login">
		<p>
			Bitte melden Sie sich an, um diesen Kommentar zu melden.
		</p>
                {% if request.registry.settings.sso_activate %}
		    <a class="button" href="{{ request.registry.settings.sso_url }}/anmelden?url={{ view.content_url | e }}">
		        	Anmelden
		    </a>
		    <a class="button" href="{{ request.registry.settings.sso_url }}/registrieren?url={{ view.content_url | e }}">
		        	Registrieren
		    </a>
                {% else %}
		    <a class="button" href="{{ request.registry.settings.community_host }}/user/login?destination={{ view.content_url | e }}">
		        	Anmelden
		    </a>
		    <a class="button" href="{{ request.registry.settings.community_host }}/user/register?destination={{ view.content_url | e }}">
		        	Registrieren
		    </a>
                {% endif %}
	</form>
{%- endif %}
</script>
